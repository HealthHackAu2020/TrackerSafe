@inherits LayoutComponentBase
@inject HttpClient Http
@inject NavigationManager navManager
@inject Blazored.LocalStorage.ISyncLocalStorageService localStorage
@inject ILogger<MainLayout> logger
@* <div class="fixed-top justify-content-center bg-light">
  <p>&nbsp;<!--Top bar content will go here--></p>
</div> *@
<div class="main">
  @if (isLoading)
  {
    <div class="alert alert-info row justify-content-center" role="alert">
      <Spinner></Spinner>Loading...
    </div>
  }
  else
  {
    <div class="content px-4">
      @Body
    </div>
  }
  
  <div class="fixed-bottom justify-content-center bg-light bottom-bar">
    <div class="btn-group" role="group">
      <button class="btn btn-secondary" type="button" disabled="@(!isLoggedIn)">
        <i class="fas fa-user"></i>
        <br />
        My Profile
      </button>
    </div>
    <div class="btn-group" role="group">
      <button class="btn btn-secondary" type="button" disabled="@(!isLoggedIn)">
        <i class="fas fa-compass"></i>
        <br />
        Check-in
      </button>
    </div>
    <div class="btn-group" role="group">
      <button class="btn btn-secondary" type="button" disabled="@(!isLoggedIn)">
        <i class="fas fa-star"></i>
        <br />
        Rewards
      </button>
    </div>
    <div class="btn-group" role="group">
      <button class="btn btn-secondary" type="button" disabled="@(!isLoggedIn)">
        <i class="fas fa-book-reader"></i>
        <br />
        Learn More
      </button>
    </div>
    <div class="btn-group" role="group">
      <button class="btn btn-secondary" type="button" disabled="@(!isLoggedIn)">
        <i class="fas fa-users"></i>
        <br />
        Teams
      </button>
    </div>
  </div>
</div>

@code
{
  private bool isLoggedIn = false;

  private bool isLoading = false;

  protected async override Task OnInitializedAsync()
  {
    await base.OnInitializedAsync();
    isLoading = true;
    var sessionId = Guid.NewGuid().ToString();
    logger.LogDebug("OnInitializedAsync for new session {SessionId}", sessionId);
    localStorage.SetSessionId(sessionId);

    var appState = localStorage.GetAppState();

    var result = await Http.PostApiData<GetLoggedInUserResponse, MainLayout>(navManager, logger, localStorage, $"https://trackersafe.azurewebsites.net/api/GetLoggedInUser", new GetLoggedInUserRequest());
    isLoggedIn = result != null && !string.IsNullOrWhiteSpace(result.UserName);

    logger.LogDebug("OnInitializedAsync isLoggedIn? {IsLoggedIn}; Push Notifications? {PushNotificationState}; ", isLoggedIn, appState.PushNotificationState);

    if (appState.PushNotificationState == AppState.FeatureState.None)
    {
      logger.LogDebug("PushNotificationState is None, Redirecting");
      navManager.NavigateToPage(AppConstants.PageUrlPushNotifications);
    }
    else if (appState.LocationState == AppState.FeatureState.None)
    {
      logger.LogDebug("LocationState is None, Redirecting");
      navManager.NavigateToPage(AppConstants.PageUrlGetLocation);
    }

    isLoading = false;
  }
}